<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="avicit.discussion_manage.structuralrelationship.dao.StructuralRelationshipDao">

<resultMap id="StructuralRelationshipDTOMap" type="avicit.discussion_manage.structuralrelationship.dto.StructuralRelationshipDTO">
		<result property="id" column="ID" jdbcType="VARCHAR" />
		<result property="strId" column="STR_ID" jdbcType="VARCHAR" />
		<result property="parentStrId" column="PARENT_STR_ID" jdbcType="VARCHAR" />
		<result property="instanceId" column="INSTANCE_ID" jdbcType="VARCHAR" />
		<result property="createdBy" column="CREATED_BY" jdbcType="VARCHAR" />
		<result property="creationDate" column="CREATION_DATE" jdbcType="TIMESTAMP" />
		<result property="lastUpdatedBy" column="LAST_UPDATED_BY" jdbcType="VARCHAR" />
		<result property="lastUpdateDate" column="LAST_UPDATE_DATE" jdbcType="TIMESTAMP" />
		<result property="lastUpdateIp" column="LAST_UPDATE_IP" jdbcType="VARCHAR" />
		<result property="version" column="VERSION" jdbcType="DECIMAL" />
		<result property="attribute01" column="ATTRIBUTE_01" jdbcType="VARCHAR" />
		<result property="attribute02" column="ATTRIBUTE_02" jdbcType="VARCHAR" />
		<result property="attribute03" column="ATTRIBUTE_03" jdbcType="VARCHAR" />
		<result property="attribute04" column="ATTRIBUTE_04" jdbcType="VARCHAR" />
		<result property="attribute05" column="ATTRIBUTE_05" jdbcType="VARCHAR" />
		<result property="attribute06" column="ATTRIBUTE_06" jdbcType="VARCHAR" />
		<result property="attribute07" column="ATTRIBUTE_07" jdbcType="TIMESTAMP" />
		<result property="attribute08" column="ATTRIBUTE_08" jdbcType="TIMESTAMP" />
		<result property="attribute09" column="ATTRIBUTE_09" jdbcType="DECIMAL" />
		<result property="attribute10" column="ATTRIBUTE_10" jdbcType="DECIMAL" />
		<result property="instancenumber" column="INSTANCENUMBER" jdbcType="VARCHAR" />
		<result property="createtime" column="CREATETIME" jdbcType="VARCHAR" />
		<result property="modifytime" column="MODIFYTIME" jdbcType="VARCHAR" />
		<!-- 查询型号20170729lf -->
		<result property="classCode" column="CLASS_CODE" jdbcType="VARCHAR" />
</resultMap>

<resultMap id="AddFormDataDTOMap" type="avicit.discussion_manage.structuralrelationship.dto.AddFormDataDTO">
		<result property="id" 	     column="ID" 		 jdbcType="VARCHAR" />
		<result property="className" column="CLASS_NAME" jdbcType="VARCHAR" />
		<result property="classCode" column="CLASS_CODE" jdbcType="VARCHAR" />
		<result property="classType" column="CLASS_TYPE" jdbcType="VARCHAR" />
		<result property="version"   column="VERSION" 	 jdbcType="DECIMAL" />
		<result property="status"    column="STATUS" 	 jdbcType="DECIMAL" />
		<result property="edition"   column="EDITION" 	 jdbcType="DECIMAL" />
		<result property="designerId"   column="DESIGNER_ID" 	 jdbcType="DECIMAL" />
</resultMap>

<resultMap id="StructuralRelationshipMap" type="java.util.HashMap">
	<result property="id"          column="ID"         jdbcType="VARCHAR" />
	<result property="children"    column="CHILDREN"   jdbcType="VARCHAR" />
	<result property="StrId"       column="STR_ID"     jdbcType="VARCHAR" />
	<result property="ClassCode"   column="CLASS_CODE" jdbcType="VARCHAR" />
	<result property="ParentStrId" column="PARENT_STR_ID" jdbcType="VARCHAR" />
	<result property="childCount"  column="childCount" jdbcType="VARCHAR" />
	<result property="instancenumber"  column="INSTANCENUMBER" jdbcType="VARCHAR" />
</resultMap>
<!-- 查询型号20170729lf-->
<select id="findStructuralType" parameterType="java.lang.String" resultMap="StructuralRelationshipMap">
 	SELECT 
     SM.CLASS_CODE,
        SR.STR_ID,
        SR.PARENT_STR_ID,
        SR.ID
  FROM STRUCTURAL_RELATIONSHIP SR
  LEFT JOIN STRUCTURE_MANAGE SM
  ON SR.STR_ID = SM.ID
 where SR.PARENT_STR_ID ='-100'
</select>

<!-- 初始化vci树 -->
<select id="getStructuralRelationshipByParentStrId" parameterType="java.lang.String" resultMap="StructuralRelationshipMap">
  SELECT (SELECT COUNT(1) FROM STRUCTURAL_RELATIONSHIP T1 WHERE SR.STR_ID = T1.PARENT_STR_ID) CHILDCOUNT,
 		SM.CLASS_CODE || '|' || SM.CLASS_NAME || ' ' || SM.EDITION AS CLASS_CODE,
 		SM.CLASS_NAME,
        SR.STR_ID,
        SR.PARENT_STR_ID,
        SR.ID
  FROM STRUCTURAL_RELATIONSHIP SR
  LEFT JOIN STRUCTURE_MANAGE SM
  ON SR.STR_ID = SM.ID
 where SR.PARENT_STR_ID = #{id,jdbcType=VARCHAR} 
</select>

<!-- 查询vcis -->
<select id="getZtreeStructuralRelationshipBySerchData" parameterType="avicit.discussion_manage.structuralrelationship.dto.AddFormDataDTO" resultMap="StructuralRelationshipMap">

	SELECT (SELECT COUNT(1) FROM STRUCTURAL_RELATIONSHIP T1 WHERE SR.STR_ID = T1.PARENT_STR_ID) CHILDCOUNT,
        SM.CLASS_CODE,
        SM.CLASS_NAME,
        SR.STR_ID,
        SR.PARENT_STR_ID,
        SR.ID
   FROM STRUCTURAL_RELATIONSHIP SR
   LEFT JOIN STRUCTURE_MANAGE SM
     ON SR.STR_ID = SM.ID
  WHERE (SM.CLASS_NAME LIKE '%'|| #{bean.className,jdbcType=VARCHAR}||'%' 
     AND SM.CLASS_CODE LIKE '%'|| #{bean.classCode,jdbcType=VARCHAR}||'%')
     AND SR.PARENT_STR_ID = '-100'

</select>


<!-- 调包新增对象    -->
<select id="insertStructuralRelationship"  statementType="CALLABLE"  parameterType="avicit.discussion_manage.structuralrelationship.dto.AddFormDataDTO"  resultType="java.util.Map">
	<![CDATA[
          {call mdcs_str_p.add_str_p(
		      #{tabId,			jdbcType=VARCHAR,	mode=IN},
		      #{id,				jdbcType=VARCHAR,	mode=IN},
		      #{pId,			jdbcType=VARCHAR,	mode=IN},
		      #{classType,		jdbcType=VARCHAR,	mode=IN}, 
		      #{className,		jdbcType=VARCHAR,	mode=IN},  
		      #{classCode,		jdbcType=VARCHAR,	mode=IN},
		      #{designerId,		jdbcType=VARCHAR,	mode=IN},  
		      #{addType,		jdbcType=VARCHAR,	mode=IN},
		      #{edition,		jdbcType=VARCHAR,	mode=IN},
		      #{status,			jdbcType=VARCHAR,	mode=IN},
		      #{lastUpdateIp,	jdbcType=VARCHAR,	mode=IN},
		      #{returnInt,   	jdbcType=INTEGER,   mode=OUT},
			  #{returnString,	jdbcType=VARCHAR,   mode=OUT}) 
     	 }
     ]]>  
      
</select>

<!-- 根据零件ID查寻数据-->
<select id="getAddformDataDTOById" parameterType="java.lang.String" resultMap="AddFormDataDTOMap">
  select id, class_name, class_code, class_type,version,status,edition,designer_id from structure_manage  where id = #{id,jdbcType=VARCHAR}
</select> 

<!-- 根据零件ID查寻数据-->
<select id="getDgStructuralRelationship" parameterType="java.lang.String" resultMap="AddFormDataDTOMap">
  select id, class_name, class_code, class_type,version,status,edition,designer_id from structure_manage  where id = #{id,jdbcType=VARCHAR}
</select> 

<resultMap id="ResultMap" type="java.util.HashMap">
	<result property="returnInt"     column="O_RETURN_INT" 	   jdbcType="DECIMAL" />
	<result property="returnString"  column="O_RETURN_STRING"  jdbcType="VARCHAR" />
</resultMap>

<!-- 调包更新数据    -->
<select id="updateStructureManage"  statementType="CALLABLE"  parameterType="avicit.discussion_manage.structuralrelationship.dto.AddFormDataDTO"  resultMap="ResultMap">
	<![CDATA[
          {call mdcs_str_p.update_str_p(
		      #{id,				jdbcType=VARCHAR,	mode=IN},
		      #{classType,		jdbcType=VARCHAR,	mode=IN}, 
		      #{className,		jdbcType=VARCHAR,	mode=IN},  
		      #{classCode,		jdbcType=VARCHAR,	mode=IN},
		      #{edition,		jdbcType=VARCHAR,	mode=IN},  
		      #{status,			jdbcType=VARCHAR,	mode=IN},  
		      #{returnInt,   	jdbcType=INTEGER,   mode=OUT},
			  #{returnString,	jdbcType=VARCHAR,   mode=OUT}) 
     	 }
     ]]>  
</select>

<!-- 调包根据主键删除零件 -->
<select id="deleteStructureManage"  statementType="CALLABLE"  parameterType="java.util.HashMap"  resultMap="ResultMap">
	<![CDATA[
          {call mdcs_str_p.del_str_p(
		      #{id,				jdbcType=VARCHAR,	mode=IN},
		      #{pId,			jdbcType=VARCHAR,	mode=IN}, 
		      #{returnInt,   	jdbcType=INTEGER,   mode=OUT},
			  #{returnString,	jdbcType=VARCHAR,   mode=OUT}) 
     	 }
     ]]>  
</select>
<!-- 查询零件ID-->
<select id="getStrIdByCode" parameterType="java.lang.String" resultType="java.lang.String">
  SELECT
 SR.STR_ID
  FROM STRUCTURAL_RELATIONSHIP SR
  LEFT JOIN STRUCTURE_MANAGE SM
    ON SR.STR_ID = SM.ID
 START WITH SR.STR_ID =(SELECT T.ID FROM STRUCTURE_MANAGE T WHERE T.CLASS_CODE= #{code})
CONNECT BY PRIOR SR.STR_ID = SR.PARENT_STR_ID
</select> 

<!-- 判断用户添加的零件是否存在 -->
<select id="findStrIsHasByclassCodeNew"    parameterType="java.lang.String"  resultMap="AddFormDataDTOMap">

	SELECT ID, CLASS_NAME, CLASS_CODE, CLASS_TYPE,EDITION 
		FROM MDCS.STRUCTURE_MANAGE 
			WHERE CLASS_CODE = #{classCodeNew,jdbcType=VARCHAR}
	
</select>

<!-- 保存拖拽后的数据结构 -->
<select id="toSaveDragNode"   statementType="CALLABLE"  parameterType="java.util.HashMap" >
	<![CDATA[
          {call mdcs_str_p.save_drag_node(
		      #{targetNodePid,	jdbcType=VARCHAR,	mode=IN},
		      #{tabId,			jdbcType=VARCHAR,	mode=IN}, 
		      #{returnInt,   	jdbcType=INTEGER,   mode=OUT},
			  #{returnString,	jdbcType=VARCHAR,   mode=OUT}) 
     	 }
     ]]>  
</select>

<!-- 讨论区根据零件id展示vci树 -->
<select id="searchVciZtreeByStrId"    parameterType="java.lang.String"  resultMap="StructuralRelationshipMap">
	SELECT (SELECT COUNT(1)
          FROM STRUCTURAL_RELATIONSHIP TT
         WHERE TT.PARENT_STR_ID = B.STR_ID) CHILDREN,
       B.STR_ID,
       B.INSTANCENUMBER,
       B.PARENT_STR_ID,
       SM.CLASS_CODE || '|' || SM.CLASS_NAME || ' ' || SM.EDITION AS CLASS_CODE
  FROM (SELECT T.STR_ID, T.PARENT_STR_ID,T.INSTANCENUMBER
          FROM STRUCTURAL_RELATIONSHIP T
         START WITH T.STR_ID = #{strId,jdbcType=VARCHAR}
        CONNECT BY PRIOR T.STR_ID = T.PARENT_STR_ID
        UNION ALL
        SELECT *
          FROM (SELECT DISTINCT T.STR_ID, T.PARENT_STR_ID,T.INSTANCENUMBER
                  FROM STRUCTURAL_RELATIONSHIP T
                 START WITH T.STR_ID = #{strId,jdbcType=VARCHAR}
                CONNECT BY T.STR_ID = PRIOR T.PARENT_STR_ID) F
         WHERE F.STR_ID != #{strId,jdbcType=VARCHAR}) B
  LEFT JOIN MDCS.STRUCTURE_MANAGE SM
    ON B.STR_ID = SM.ID
	
<!--	 

	SELECT (SELECT COUNT(1)
            FROM STRUCTURAL_RELATIONSHIP TT
           WHERE TT.PARENT_STR_ID = B.STR_ID) CHILDREN,
         B.STR_ID,
         B.PARENT_STR_ID,
         SM.CLASS_CODE
    FROM (SELECT DISTINCT T.STR_ID, T.PARENT_STR_ID
            FROM STRUCTURAL_RELATIONSHIP T
           START WITH T.STR_ID =  #{strId,jdbcType=VARCHAR}
          CONNECT BY PRIOR T.STR_ID =  T.PARENT_STR_ID) B
    LEFT JOIN MDCS.STRUCTURE_MANAGE SM
      ON B.STR_ID = SM.ID


  SELECT (SELECT COUNT(1)
            FROM STRUCTURAL_RELATIONSHIP TT
           WHERE TT.PARENT_STR_ID = B.STR_ID) CHILDREN,
         B.STR_ID,
         B.PARENT_STR_ID,
         SM.CLASS_CODE
    FROM (SELECT distinct T.STR_ID, T.PARENT_STR_ID
            FROM STRUCTURAL_RELATIONSHIP T
           START WITH T.STR_ID = #{strId,jdbcType=VARCHAR}
          CONNECT BY PRIOR T.STR_ID = T.PARENT_STR_ID
          UNION ALL
          SELECT distinct T.STR_ID, T.PARENT_STR_ID
            FROM STRUCTURAL_RELATIONSHIP T
           START WITH T.STR_ID = #{strId,jdbcType=VARCHAR}
          CONNECT BY T.STR_ID = PRIOR T.PARENT_STR_ID) B
    LEFT JOIN MDCS.STRUCTURE_MANAGE SM
      ON B.STR_ID = SM.ID
  -->
</select>
<!-- 新增对象 STRUCTURAL_RELATIONSHIP -->
<insert id="insertStructuralRelationships" parameterType="avicit.discussion_manage.structuralrelationship.dto.StructuralRelationshipDTO">
	insert into structural_relationship
	<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				id,
			</if>
			<if test="strId != null">
				str_id,
			</if>
			<if test="parentStrId != null">
				parent_str_id,
			</if>
			<if test="instanceId != null">
				instance_id,
			</if>
			<if test="createdBy != null">
				created_by,
			</if>
			<if test="creationDate != null">
				creation_date,
			</if>
			<if test="lastUpdatedBy != null">
				last_updated_by,
			</if>
			<if test="lastUpdateDate != null">
				last_update_date,
			</if>
			<if test="lastUpdateIp != null">
				last_update_ip,
			</if>
			<if test="version != null">
				version,
			</if>
			<if test="attribute01 != null">
				attribute_01,
			</if>
			<if test="attribute02 != null">
				attribute_02,
			</if>
			<if test="attribute03 != null">
				attribute_03,
			</if>
			<if test="attribute04 != null">
				attribute_04,
			</if>
			<if test="attribute05 != null">
				attribute_05,
			</if>
			<if test="attribute06 != null">
				attribute_06,
			</if>
			<if test="attribute07 != null">
				attribute_07,
			</if>
			<if test="attribute08 != null">
				attribute_08,
			</if>
			<if test="attribute09 != null">
				attribute_09,
			</if>
			<if test="attribute10 != null">
				attribute_10,
			</if>
			<if test="instancenumber != null">
				instancenumber,
			</if>
			<if test="createtime != null">
				createtime,
			</if>
			<if test="modifytime != null">
				modifytime,
			</if>
	</trim>
	<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=VARCHAR},
			</if>
			<if test="strId != null">
				#{strId,jdbcType=VARCHAR},
			</if>
			<if test="parentStrId != null">
				#{parentStrId,jdbcType=VARCHAR},
			</if>
			<if test="instanceId != null">
				#{instanceId,jdbcType=VARCHAR},
			</if>
			<if test="createdBy != null">
				#{createdBy,jdbcType=VARCHAR},
			</if>
			<if test="creationDate != null">
				#{creationDate},
			</if>
			<if test="lastUpdatedBy != null">
				#{lastUpdatedBy,jdbcType=VARCHAR},
			</if>
			<if test="lastUpdateDate != null">
				#{lastUpdateDate},
			</if>
			<if test="lastUpdateIp != null">
				#{lastUpdateIp,jdbcType=VARCHAR},
			</if>
			<if test="version != null">
				#{version,jdbcType=DECIMAL},
			</if>
			<if test="attribute01 != null">
				#{attribute01,jdbcType=VARCHAR},
			</if>
			<if test="attribute02 != null">
				#{attribute02,jdbcType=VARCHAR},
			</if>
			<if test="attribute03 != null">
				#{attribute03,jdbcType=VARCHAR},
			</if>
			<if test="attribute04 != null">
				#{attribute04,jdbcType=VARCHAR},
			</if>
			<if test="attribute05 != null">
				#{attribute05,jdbcType=VARCHAR},
			</if>
			<if test="attribute06 != null">
				#{attribute06,jdbcType=VARCHAR},
			</if>
			<if test="attribute07 != null">
				#{attribute07,jdbcType=DATE},
			</if>
			<if test="attribute08 != null">
				#{attribute08,jdbcType=DATE},
			</if>
			<if test="attribute09 != null">
				#{attribute09,jdbcType=DECIMAL},
			</if>
			<if test="attribute10 != null">
				#{attribute10,jdbcType=DECIMAL},
			</if>
			<if test="instancenumber != null">
				#{instancenumber,jdbcType=VARCHAR},
			</if>
			<if test="createtime != null">
				#{createtime,jdbcType=VARCHAR},
			</if>
			<if test="modifytime != null">
				#{modifytime,jdbcType=VARCHAR},
			</if>
	</trim>
</insert>
<!-- 更新对象 STRUCTURAL_RELATIONSHIP -->
<update id="updateStructuralRelationshipSensitive" parameterType="avicit.discussion_manage.structuralrelationship.dto.StructuralRelationshipDTO">
	update structural_relationship t1
	<set>
			<if test="id != null">
				t1.id                             =#{id,jdbcType=VARCHAR},
			</if>
			<if test="strId != null">
				t1.str_id                         =#{strId,jdbcType=VARCHAR},
			</if>
			<if test="parentStrId != null">
				t1.parent_str_id                  =#{parentStrId,jdbcType=VARCHAR},
			</if>
			<if test="instanceId != null">
				t1.instance_id                    =#{instanceId,jdbcType=VARCHAR},
			</if>
			<if test="createdBy != null">
				t1.created_by                     =#{createdBy,jdbcType=VARCHAR},
			</if>
			<if test="creationDate != null">
				t1.creation_date                  =#{creationDate},
			</if>
			<if test="lastUpdatedBy != null">
				t1.last_updated_by                =#{lastUpdatedBy,jdbcType=VARCHAR},
			</if>
			<if test="lastUpdateDate != null">
				t1.last_update_date               =#{lastUpdateDate},
			</if>
			<if test="lastUpdateIp != null">
				t1.last_update_ip                 =#{lastUpdateIp,jdbcType=VARCHAR},
			</if>
			<if test="version != null">
				t1.version                        =t1.version+1,
			</if>
			<if test="attribute01 != null">
				t1.attribute_01                   =#{attribute01,jdbcType=VARCHAR},
			</if>
			<if test="attribute02 != null">
				t1.attribute_02                   =#{attribute02,jdbcType=VARCHAR},
			</if>
			<if test="attribute03 != null">
				t1.attribute_03                   =#{attribute03,jdbcType=VARCHAR},
			</if>
			<if test="attribute04 != null">
				t1.attribute_04                   =#{attribute04,jdbcType=VARCHAR},
			</if>
			<if test="attribute05 != null">
				t1.attribute_05                   =#{attribute05,jdbcType=VARCHAR},
			</if>
			<if test="attribute06 != null">
				t1.attribute_06                   =#{attribute06,jdbcType=VARCHAR},
			</if>
			<if test="attribute07 != null">
				t1.attribute_07                   =#{attribute07,jdbcType=DATE},
			</if>
			<if test="attribute08 != null">
				t1.attribute_08                   =#{attribute08,jdbcType=DATE},
			</if>
			<if test="attribute09 != null">
				t1.attribute_09                   =#{attribute09,jdbcType=DECIMAL},
			</if>
			<if test="attribute10 != null">
				t1.attribute_10                   =#{attribute10,jdbcType=DECIMAL},
			</if>
			<if test="instancenumber != null">
				t1.instancenumber                 =#{instancenumber,jdbcType=VARCHAR},
			</if>
			<if test="createtime != null">
				t1.createtime                     =#{createtime,jdbcType=VARCHAR},
			</if>
			<if test="modifytime != null">
				t1.modifytime                     =#{modifytime,jdbcType=VARCHAR},
			</if>
	</set>
		where t1.id = #{id} and t1.version =#{version}
</update>
<!-- 主键查询对象 STRUCTURAL_RELATIONSHIP -->
<select id="findStructuralRelationshipById" parameterType="java.util.Map" resultMap="StructuralRelationshipDTOMap">
	select
		t1.id                             ,
		t1.str_id                         ,
		t1.parent_str_id                  ,
		t1.instance_id                    ,
		t1.created_by                     ,
		t1.creation_date                  ,
		t1.last_updated_by                ,
		t1.last_update_date               ,
		t1.last_update_ip                 ,
		t1.version                        ,
		t1.attribute_01                   ,
		t1.attribute_02                   ,
		t1.attribute_03                   ,
		t1.attribute_04                   ,
		t1.attribute_05                   ,
		t1.attribute_06                   ,
		t1.attribute_07                   ,
		t1.attribute_08                   ,
		t1.attribute_09                   ,
		t1.attribute_10                   ,
		t1.instancenumber                 ,
		t1.createtime                     ,
		t1.modifytime                     
	from structural_relationship 	t1
		where t1.id = #{id}
</select>
</mapper>