<%@ page language="java" contentType="text/html; charset=utf-8"
	pageEncoding="utf-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@taglib prefix="sec" uri="/WEB-INF/tags/shiro.tld"%>
<%@taglib prefix="pt6" uri="/WEB-INF/tags/platform6.tld"%>
<%@ page import="avicit.platform6.commons.utils.ViewUtil"%>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-Control" content="no-cache">
<!-- ControllerPath = "discussion_manage/structuralrelationship/StructuralRelationshipController/StructuralRelationshipInfo" -->
<title>tree</title>
<base href="<%=ViewUtil.getRequestPath(request)%>">
<%
	String strid = request.getParameter("id") == null ? "" : request
			.getParameter("id");
%>
</head>
<jsp:include
	page="/avicit/platform6/component/common/EasyUIJsInclude.jsp"></jsp:include>
<jsp:include
	page="/avicit/discussion_manage/structuralrelationship/ztreeLayuiInclude.jsp"></jsp:include>
<style>
/* .badge {
	display: inline-block;
	min-width: 10px;
	padding: 1px;
	font-size: 10px;
	font-size: 12px\9;
	line-height: 1;
	margin-left: 5px;
	color: #fff;
	text-align: center;
	white-space: nowrap;
	vertical-align: baseline;
	background-color: #eee;
	border-radius: 3px;
	margin-right: 3px;
} */
.mainSection {
	width: 100%;
	padding-left: 0;
	font-size: 13px;
	position: relative;
}

.addLabel {
	position: absolute;
	top: 31px;
	left: 70px;
	display: none;
	width: 150px;
	height: auto;
	box-shadow: 0px 0px 5px #dddddd;
	border: 1px solid #dddddd;
}

.addLabelList {
	position: absolute;
	width: 150px;
	height: auto;
	background-color: #FFFFFF;
	z-index: 99;
	text-align: left;
}

.addLabelList ul {
	margin: 0;
	padding: 0;
	list-style: none;
	width: 100%;
	box-shadow: 0px 0px 5px #dddddd;
	border: 1px solid #dddddd;
}

.addLabelList ul li {
	padding: 5px 10px 5px 10px;
	list-style: none;
	cursor: pointer;
	font-size: 12px;
	border-bottom: 1px solid #f7f7f7;
	-webkit-user-select: none;
}

.addLabelList ul li.active { /*鼠标移动上去背景色  */
	background: #2ea7e0;
}

.addLabelList ul li:hover {
	background: #2ea7e0;
	color: #FFFFFF;
}
</style>
<script type="text/javascript">
	 var strid ='<%=strid%>';
	var setting = {
		async : {
			autoParam : [ "id" ],
			dataType : "json",
			enable : true,
			type : "get",
			url : "platform/discussion_manage/structuralrelationship/StructuralRelationshipController/searchVciZtreeByStrId/"
					+ strid,
		},
		data : {
			simpleData : {
				enable : true
			}
		},
		callback : {
			onClick : zTreeOnClick,
		}
	};
	function getFont(treeId, node) {
		return node.font ? node.font : {};
	}

	//初始化树
	$(function() {
		$.fn.zTree.init($("#tree"), setting);
		setTimeout(selectNodeById, 100);
		findDiscussionDate();
	});

	//选中节点
	function selectNodeById() {
		var zTree = $.fn.zTree.getZTreeObj("tree");
		var selecrNode = zTree.getNodeByParam("id", strid);
		zTree.selectNode(selecrNode);
	};

	//初始化datagrid
	function findDiscussionDate() {
		$("#dgDiscussion")
				.datagrid(
						{
							url : 'platform/discussion_manage/discussionmanage/DiscussionManageController/selectDiscussionData/'
									+ strid
						});
	};

	//获取选择节点数据
	var selectNode = null;
	function zTreeOnClick(event, treeId, treeNode) {
		getDgStructuralRelationship(treeNode.id);
		selectNode = treeNode;
	};
	function formateDate(value, row, index) {
		return formate(value);
	}
	function formate(value) {
		if (value) {
			return new Date(value).format("yyyy-MM-dd");
		}
		return '';
	};
	var json = [ {
		"id" : 1,
		"code" : "重量",
		"jianyi" : "太重",
		"user" : "张三",
		"time" : "2017-2-3",
		"number" : 3,
		"state" : "关闭"
	}, {
		"id" : 1,
		"code" : "重量",
		"jianyi" : "太重",
		"user" : "张三",
		"time" : "2017-2-3",
		"number" : 3,
		"state" : "关闭"
	}, {
		"id" : 3,
		"code" : "重量",
		"jianyi" : "太重",
		"user" : "张三",
		"time" : "2017-2-3",
		"number" : 3,
		"state" : "关闭"
	}, {
		"id" : 4,
		"code" : "材料",
		"jianyi" : "太重",
		"user" : "张三",
		"time" : "2017-2-3",
		"number" : 3,
		"state" : "关闭"
	}, {
		"id" : 5,
		"code" : "材料",
		"jianyi" : "太重",
		"user" : "张三",
		"time" : "2017-2-3",
		"number" : 3,
		"state" : "关闭"
	}, {
		"id" : 6,
		"code" : "装配",
		"jianyi" : "太重",
		"user" : "张三",
		"time" : "2017-2-3",
		"number" : 3,
		"state" : "关闭"
	}, {
		"id" : 7,
		"code" : "装配",
		"jianyi" : "太重",
		"user" : "张三",
		"time" : "2017-2-3",
		"number" : 3,
		"state" : "关闭"
	}, {
		"id" : 8,
		"code" : "装配",
		"jianyi" : "太重",
		"user" : "张三",
		"time" : "2017-2-3",
		"number" : 3,
		"state" : "关闭"
	}, {
		"id" : 9,
		"code" : "装配",
		"jianyi" : "太重",
		"user" : "张三",
		"time" : "2017-2-3",
		"number" : 3,
		"state" : "关闭"
	}, {
		"id" : 12,
		"code" : "装配",
		"jianyi" : "太重",
		"user" : "张三",
		"time" : "2017-2-3",
		"number" : 3,
		"state" : "关闭"
	}, {
		"id" : 13,
		"code" : "装配",
		"jianyi" : "太重",
		"user" : "张三",
		"time" : "2017-2-3",
		"number" : 3,
		"state" : "关闭"
	}, {
		"id" : 14,
		"code" : "装配",
		"jianyi" : "太重",
		"user" : "张三",
		"time" : "2017-2-3",
		"number" : 3,
		"state" : "关闭"
	}, {
		"id" : 15,
		"code" : "装配",
		"jianyi" : "太重",
		"user" : "张三",
		"time" : "2017-2-3",
		"number" : 3,
		"state" : "关闭"
	} ];

	$.extend($.fn.datagrid.methods, {

		autoMergeCells : function(jq, fields) {

			return jq.each(function() {

				var target = $(this);

				if (!fields) {

					fields = target.datagrid("getColumnFields");

				}

				var rows = target.datagrid("getRows");

				var i = 0,

				j = 0,

				temp = {};

				for (i; i < rows.length; i++) {

					var row = rows[i];

					j = 0;

					for (j; j < fields.length; j++) {

						var field = fields[j];

						var tf = temp[field];

						if (!tf) {

							tf = temp[field] = {};

							tf[row[field]] = [ i ];

						} else {

							var tfv = tf[row[field]];

							if (tfv) {

								tfv.push(i);

							} else {

								tfv = tf[row[field]] = [ i ];

							}

						}
					}

				}

				$.each(temp, function(field, colunm) {

					$.each(colunm, function() {

						var group = this;

						if (group.length > 1) {

							var before,

							after,

							megerIndex = group[0];

							for ( var i = 0; i < group.length; i++) {

								before = group[i];

								after = group[i + 1];

								if (after && (after - before) == 1) {

									continue;

								}

								var rowspan = before - megerIndex + 1;

								if (rowspan > 1) {

									target.datagrid('mergeCells', {

										index : megerIndex,

										field : field,

										rowspan : rowspan

									});

								}

								if (after && (after - before) != 1) {

									megerIndex = after;

								}

							}

						}

					});

				});

			});

		}

	});
	 /*合并相同单元格  */
	function onLoads() {
		$("#tables").datagrid('autoMergeCells', [ "code" ]);
	};
	/*设为争议  */
	function zhengyi() {
		var ro = $("#tables").datagrid('getSelected');
		ro.jianyi = ro.jianyi + "<span class=\"badge badge-danger\">争议</span>";
		$("#tables").datagrid('refreshRow', 1);
		onLoads();
	};
	/*点击按钮控制下拉框显示  */
	function choose() {
		var dis = $(".addLabel").css("display");
		if (dis == "none") {
			$(".addLabel").css("display", "block");
		} else {
			$(".addLabel").css("display", "none");
		}
	};
</script>

</head>
<body class="easyui-layout" fit="true">
	<div data-options="region:'west',split:true,title:'vci树结构'"
		style="width: 250px" <ul id="tree" class="ztree"></ul></div>
	<div data-options="region:'center',split:true"
		style="padding: 0px; overflow: auto;">
		<div id="tt" class="easyui-tabs"
			style="padding: 0px; width: auto; height: auto;">
			<div title="讨论区" style="padding: 0px;">
				<div id="toolbarStructureManage" class="datagrid-toolbar">
					<div class="mainSection">
						<a id="state-btn" class="easyui-linkbutton"
							data-options="iconCls:'icon-add',iconAlign:'right'" plain="true"
							href="javascript:void(0);" onclick="choose();">状态筛选</a>
						<div class="addLabel">
							<div class="addLabelList" style="width: 150px;">
								<ul>
									<li val="0">待处理</li>

									<li val="1">处理中</li>

									<li val="8">已解决</li>

									<li val="9">重新开始(未解决)</li>

									<li val="2">待补充(描述不清)</li>

									<li val="3">待补充(等待反馈)</li>

									<li val="4">已接受(等待处理)</li>

									<li val="5">已接受(延期处理)</li>

									<li val="6">不解决(设计如此)</li>

									<li val="7">已补充</li>
								</ul>
							</div>
						</div>
						<table align="right">
							<tr>
								<sec:accesscontrollist hasPermission="3"
									domainObject="formdialog_structureManage_table_${param.standName}"
									permissionDes="添加">
									<td><a class="easyui-linkbutton" iconCls="icon-add"
										plain="true" onclick="zhengyi();" href="javascript:void(0);">设为争议</a></td>
								</sec:accesscontrollist>
								<sec:accesscontrollist hasPermission="3"
									domainObject="formdialog_structureManage_button_edit"
									permissionDes="编辑">
									<td><a class="easyui-linkbutton" iconCls="icon-edit"
										plain="true" onclick="" href="javascript:void(0);">关闭建议</a></td>
								</sec:accesscontrollist>
							</tr>
						</table>
					</div>
				</div>
				<table id="tables" class="easyui-datagrid"
					data-options="fit:true,
					data:json,
					idField:'id',
					border: false,
					rownumbers: true,
					animate: true,
					collapsible: false,
					fitColumns: true,
					autoRowHeight: false,
					toolbar:'#toolbarStructureManage',
					singleSelect: true,
					checkOnSelect: true,
					selectOnCheck: false,
					onLoadSuccess: onLoads,
					pagination:true,
					pageSize:dataOptions.pageSize,
					pageList:dataOptions.pageList,
					striped:false">
					<thead>
						<tr>
							<th data-options="field:'id',width:200,hidden:true">id</th>
							<th data-options="field:'code',width:200,align:'center'">部门</th>
							<th data-options="field:'jianyi',width:200,align:'center'">建议</th>
							<th data-options="field:'user',width:200,align:'center'">发表人</th>
							<th data-options="field:'time',width:200,align:'center'">发表时间</th>
							<th data-options="field:'number',width:200,align:'center'">回复数量</th>
							<th data-options="field:'state',width:200,align:'center'">状态</th>
						</tr>
					</thead>
				</table>
			</div>
			<div title="模型质量检查" data-options="closable:true,closable:false"
				style="overflow: auto; padding: 20px;">
				<span class="badge badge-danger">争议</span>
			</div>
			<div title="模型干涉检查"
				data-options="iconCls:'icon-reload',closable:true,closable:false"
				style="padding: 20px;"></div>
		</div>

	</div>
</body>
</html>