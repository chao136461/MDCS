<%@ page language="java" contentType="text/html; charset=utf-8"
	pageEncoding="utf-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@taglib prefix="sec" uri="/WEB-INF/tags/shiro.tld"%>
<%@taglib prefix="pt6" uri="/WEB-INF/tags/platform6.tld"%>
<%@ page import="avicit.platform6.commons.utils.ViewUtil"%>
<%@ page import="avicit.platform6.api.session.SessionHelper"%>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-Control" content="no-cache">
<!-- ControllerPath = "discussion_manage/structuralrelationship/StructuralRelationshipController/StructuralRelationshipInfo" -->
<title>tree</title>
<base href="<%=ViewUtil.getRequestPath(request)%>">
</head>
<jsp:include
	page="/avicit/platform6/component/common/EasyUIJsInclude.jsp"></jsp:include>
<jsp:include
	page="/avicit/discussion_manage/structuralrelationship/ztreeLayuiInclude.jsp"></jsp:include>
<script type="text/javascript" src="avicit/discussion_manage/discussionmanage/js/jquery.mousewheel.js"></script>
<link rel="stylesheet" type="text/css" href="avicit/discussion_manage/discussionmanage/js/Forum.css"/>
<%
	String id = request.getParameter("id");


	String applyUserId = SessionHelper.getLoginSysUser(request).getId();
	String applyUserName = SessionHelper.getLoginSysUser(request).getName();
	String applyDeptId = SessionHelper.getCurrentDeptId(request);
	String applyDeptName = SessionHelper.getCurrentDeptTl(request).getDeptName();

%>


<script type="text/javascript">
	
	var id = '<%=id%>';
	var applyUserName='<%=applyUserName%>';
	var datas;
	var proposal;
    $(function(){
    	$.ajax({
    		url:'platform/discussion_manage/proposalmanage/ProposalManageController/operation/forum',
    		data:{id:id},
    		type:'post',
    		dataType : 'json',
    		success:function(r){
    			if(r.flag=="success"){
    				datas=r.datas;
    				proposal=r.proposal;
    				$('.txt').html(proposal.proposalMain);
    				$('.time').html("发表于:&nbsp;"+formate(proposal.publicationTime));
    				$('h1').html("#"+proposal.strId+"#"+":"+proposal.proposalMain);
    				
    				for(var i = 0,len =datas.length;i<len;i++){
    				alert(datas[i].proposalUserId);
  		            $('#headse').attr('src','platform/sysuser/photo/upload/headerphoto?sysUserId='+datas[i].proposalUserId);
  				 	var commentList = $('.comment-list')[i];
  		            var textarea = $('.comment')[i];
  		            var commentBox = document.createElement('div');
  		            commentBox.className = 'comment-box clearfix';
  		            commentBox.setAttribute('user', 'self');
  		            	
  		            commentBox.innerHTML =
  		                '<img class="myhead" src="avicit/discussion_manage/discussionmanage/js/images/my.jpg" alt=""/>' +
  		                    '<div class="comment-content">' +
  		                    '<p class="comment-text"><span class="user">'+datas[i].proposalUserIdAlias+'&nbsp;&nbsp;回复:&nbsp;&nbsp;'+'</span>' + datas[i].proposalMain + '</p>' +
  		                    '<p class="comment-time">' +
  		                  formate(datas[i].publicationTime) +
  		                    /* '<a href="javascript:;" class="comment-praise" total="0" my="0" style="">赞</a>' + */
  		                    '<a href="javascript:;" class="comment-operate">删除</a>' +
  		                    '</p>' +
  		                    '</div>'
  		            commentList.appendChild(commentBox);
  		            textarea.value = '';
  		            textarea.onblur();
  		            }
    			
    			
    			}
    		}
    	});
    	
    	$('#bodys').bind('mousewheel', function(event, delta) {
    	  	var dir = delta > 0 ? 'Up' : 'Down';
    	  	if (dir == 'Up') {
    	  		$('#nouses').hide();
    	  	} else {
    	  		$('#nouses').show();
    	  	}
    	  	});
    	
    	var list = $('#list');//获取list容器
    	var lis = list.children();
    	var timer;
    	 //格式化日期
        function formateDate(date) {
            var y = date.getFullYear();
            var m = date.getMonth() + 1;
            var d = date.getDate();
            var h = date.getHours();
            var mi = date.getMinutes();
            m = m > 9 ? m : '0' + m;
            return y + '-' + m + '-' + d + ' ' + h + ':' + mi;
        }
        function formate(value) {
    		if (value) {
    			return new Date(value).format("yyyy-MM-dd");
    		}
    		return '';
    	};
    	//删除节点
        function removeNode(node) {
            node.parentNode.removeChild(node);
        }
    	
        /**
         * 赞分享
         * @param box 每个分享的div容器
         * @param el 点击的元素
         */
       /*  function praiseBox(box, el) {
            var txt = el.innerHTML;
            var praisesTotal = $('.praises-total')[0];
            var oldTotal = parseInt(praisesTotal.getAttribute('total'));
            var newTotal;
            if (txt == '赞') {
                newTotal = oldTotal + 1;
                praisesTotal.setAttribute('total', newTotal);
                praisesTotal.innerHTML = (newTotal == 1) ? '我觉得很赞' : '我和' + oldTotal + '个人觉得很赞';
                el.innerHTML = '取消赞';
            }
            else {
                newTotal = oldTotal - 1;
                praisesTotal.setAttribute('total', newTotal);
                praisesTotal.innerHTML = (newTotal == 0) ? '' : newTotal + '个人觉得很赞';
                el.innerHTML = '赞';
            }
            praisesTotal.style.display = (newTotal == 0) ? 'none' : 'block';
        } */

        /**
         * 发评论
         * @param box 每个分享的div容器
         * @param el 点击的元素
         */
        function reply(box, el) {
            var commentList = $('.comment-list')[0];
            var textarea = $('.comment')[0];
            var commentBox = document.createElement('div');
            commentBox.className = 'comment-box clearfix';
            commentBox.setAttribute('user', 'self');
            commentBox.innerHTML =
                '<img class="myhead" src="avicit/discussion_manage/discussionmanage/js/images/my.jpg" alt=""/>' +
                    '<div class="comment-content">' +
                    '<p class="comment-text"><span class="user">'+applyUserName+'&nbsp;&nbsp;回复:&nbsp;&nbsp;'+'</span>' + textarea.value + '</p>' +
                    '<p class="comment-time">' +
                    formateDate(new Date()) +
                    /* '<a href="javascript:;" class="comment-praise" total="0" my="0" style="">赞</a>' + */
                    '<a href="javascript:;" class="comment-operate">删除</a>' +
                    '</p>' +
                    '</div>'
            commentList.appendChild(commentBox);
            textarea.value = '';
            textarea.onblur();
        }

        

        /**
         * 操作留言
         * @param el 点击的元素
         */
        function operate(el) {
            var commentBox = el.parentNode.parentNode.parentNode;
            var box = commentBox.parentNode.parentNode.parentNode;
            var txt = el.innerHTML;
            var user = $('.user')[0].innerHTML;
            var textarea = $('.comment')[0];
            if (txt == '回复') {
                textarea.focus();
                textarea.value = '回复' + user;
                textarea.onkeyup();
            }
            else {
                removeNode(commentBox);
            }
        }
    	
        //把事件代理到每条分享div容器
    	for(var i=0;i<lis.length;i++){
    		//给每一个点击的按钮加上点击事件
    		lis[i].onclick = function(e){
    			e = e || window.event;//兼容ie8问题
    			var el = e.srcElement;
    			switch (el.className) {

                //关闭分享
                case 'close':
                    removeNode(el.parentNode);
                    break;

                 //赞分享
                case 'praise':
                    praiseBox(el.parentNode.parentNode.parentNode, el);
                    break;

                //回复按钮栏
                case 'btn':
                    reply(el.parentNode.parentNode.parentNode, el);
                    break;

                //回复按钮灰
                case 'btn btn-off':
                    clearTimeout(timer);
                    break;

                //赞留言
                case 'comment-praise':
                    praiseReply(el);
                    break;

                //操作留言
                case 'comment-operate':
                    operate(el);
                    break; 
            }
    		}
    	}
        
    	//评论
        var textArea = $('.comment')[0];
        //评论获取焦点
        textArea.onfocus = function () {
        	
            this.parentNode.className = 'text-box text-box-on';
            this.value = this.value == '评论…' ? '' : this.value;
            this.onkeyup();
        }

        //评论失去焦点
        textArea.onblur = function () {
            var me = this;
            var val = me.value;
            if (val == '') {
                timer = setTimeout(function () {
                    me.value = '评论…';
                    me.parentNode.className = 'text-box';
                }, 200);
            }
        }

        //评论按键事件
        textArea.onkeyup = function () {
            var val = this.value;
            var len = val.length;
            var els = this.parentNode.children;
            var btn = els[1];
            var word = els[2];
            if (len <=0 || len > 500) {
                btn.className = 'btn btn-off';
            }
            else {
                btn.className = 'btn';
            }
            word.innerHTML = len + '/500';
        }
        $('.goTop').click(function(){
            var timer = setInterval(function () {
              var toTop = document.documentElement.scrollTop || document.body.scrollTop;
              // 判断是否到达顶部，到达顶部停止滚动，没到达顶部继续滚动
              if(toTop == 0){
                clearInterval(timer);
              }else {
                // 设置滚动速度
                var speed = Math.ceil(toTop/5);
                // 页面向上滚动
                document.documentElement.scrollTop=document.body.scrollTop=toTop-speed;
              }
            },5);
          }); 
        
        
        
        
    });
   

	/* js代码 */
  var topBtn = $('.goTop');
  // 获取视窗高度
  var winHeight = document.documentElement.clientHeight;
  window.onscroll = function () {
    // 获取页面向上滚动距离，chrome浏览器识别document.body.scrollTop，而火狐识别document.documentElement.scrollTop，这里做了兼容处理
    var toTop = document.documentElement.scrollTop || document.body.scrollTop;
    // 如果滚动超过一屏，返回顶部按钮出现，反之隐藏
    if(toTop>=50){
      $('.goTop').css('display','block');
    }else {
    	$('.goTop').css('display','none');
    }
  }
  
  
</script>

    
</head>
<body id="bodys" >
<div id="nouses" ><h1 style="font-size: 20px;line-height: 40px;padding-left: 80px;">#YJBH001# : 重量不合适</h1></div>
<div id="list">
        <div style="background-color: #fff;height: 50px;width:100.3%;text-align: left;"><h1 style="font-size: 20px;line-height: 50px;padding-left: 80px;">#YJBH001# : 重量不合适</h1></div>
        <div class="box clearfix">
            <!-- <a class="close" href="javascript:;">×</a> -->
            <div class="head">
            <table>
            <tr>
            <td align="center"><img id="headse" class="heads"  alt=""/></td>
            </tr>
            <tr>
            	<td align="center">张三</td>
            </tr>
            <tr>
            	<td align="center">重量室主任</td>
            </tr>
            </table>
            </div>
            <div class="content">
                <div class="main">
                    <p class="txt">
                    </p>
                    <img class="pic" src="avicit/discussion_manage/discussionmanage/js/images/u349.png" alt=""/>
                </div>
                <div class="info clearfix">
                    <span class="time">发表于:</span>
                    
                   <a title="设置争议" id="praise" 
						class="easyui-linkbutton"  data-options="iconCls:'icon-flagred'" onclick="" plain="true" 
						href="javascript:void(0);">设置争议</a>
                   <a id="praise" title="关闭" 
						class="easyui-linkbutton"  data-options="iconCls:'icon-lockzy'" onclick="" plain="true" 
						href="javascript:void(0);">关闭</a>
                   <a id="praise" title="视角转换" 
						class="easyui-linkbutton"  data-options="iconCls:'icon-world_link'" onclick="" plain="true" 
						href="javascript:void(0);">视角转换</a>
                </div>
                <!-- <div class="praises-total" total="4" style="display: block;">4个人觉得很赞</div> -->
                <div class="comment-list">
                    <div class="comment-box clearfix" user="self">
                      <!--   <img class="myhead" src="avicit/discussion_manage/discussionmanage/js/images/my.jpg" alt=""/>
                        <div class="comment-content">
                            <p class="comment-text"><span class="user">我：</span>我试试。</p>
                            <p class="comment-time">
                                2017-7-14 10:51
                                <a href="javascript:;" class="comment-praise" total="1" my="0" style="display: inline-block">1 赞</a>
                                <a href="javascript:;" class="comment-operate">删除</a>
                                <a href="javascript:;" class="comment-operate">回复</a>
                            </p>
                        </div> -->
                    </div>
                </div>
                <div class="text-box">
                    <textarea class="comment" autocomplete="off">评论…</textarea>
                    <button class="btn ">回 复</button>
                    <span class="word"><span class="length">0</span>/500</span>
                </div>
            </div>
        </div>
    </div>
<div class="goTop" style="display: none;"></div>
</body>
</html>